<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta HTTP-EQUIV="Expires" CONTENT="-1" />
    <meta HTTP-EQUIV="Pragma" CONTENT="no-cache" />

    <style>
        html, body {
            margin: 0;
            background-color: #fff;
            display: flex;
            overflow: hidden;
        }
        iframe {
            position: absolute;
            z-index: 0;
            left: 0px;
            top: 0px;
            width: 100vw;
            height: 100vh;
        }
    </style>
    <script>
        async function start() {
            let preloadingIFrame;
            let liveIFrame;

            preloadingIFrame = await preload();

            while (true) {
                const then = performance.now();

                play(preloadingIFrame, liveIFrame);
                liveIFrame = preloadingIFrame;

                await delay(5000);
                log('Preloading', performance.now() - then)
                preloadingIFrame = await preload();
                log('Preloaded', performance.now() - then)
                await delay(9500 - performance.now() + then);

                log('Playing', performance.now() - then)
            }

            function preload() {
                const preloadingIFrame = document.createElement('iframe');
                preloadingIFrame.allow = "camera *; microphone *; autoplay *";
                document.body.append(preloadingIFrame);

                const p = new Promise((resolve) => {
                    window.onmessage = (ev) => {
                        if (typeof ev.data !== 'string')
                            return;
                        if (ev.data.toUpperCase() === 'PRELOADED') {
                            window.onmessage = null;
                            resolve(preloadingIFrame);
                        }
                    };
                });

                preloadingIFrame.src = 'iframe.html';
                return p;
            }

            function play(preloadingFE, liveFE) {
                preloadingFE.contentWindow.postMessage('PLAY', '*');
                preloadingFE.style.visibility = 'visible';
                if (liveFE)
                    liveFE.remove();
            }

            function delay(ms) {
                return (ms <= 0
                    ? Promise.resolve()
                    : new Promise((resolve) => setTimeout(resolve, ms)));
            }
        }
    </script>
</head>
<body>
    <iframe src="player.html" sandbox="allow-same-origin allow-scripts" allow="camera *; microphone *; autoplay *"></iframe>
</body>
</html>
